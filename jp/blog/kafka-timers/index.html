<!doctype html>
<html lang="jp" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Kafka timers | Working Group Two</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.wgtwo.com//jp/img/wgtwo-logo-white-bg.png"><meta data-rh="true" name="twitter:image" content="https://www.wgtwo.com//jp/img/wgtwo-logo-white-bg.png"><meta data-rh="true" property="og:url" content="https://www.wgtwo.com//jp/blog/kafka-timers/"><meta data-rh="true" name="docusaurus_locale" content="jp"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="jp"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="og:description" content="We help mobile operators innovate at scale, reduce cost and dive into new revenue streams - by building a mobile core network from the ground up and delivering it as-a-service."><meta data-rh="true" name="og:image" content="/img/wgtwo-logo-white-bg.png"><meta data-rh="true" name="keywords" content="mvne, private network, epc, 5G core, mvno, IMS core, mobile core, evolved packet core epc, mvno core, core as a service&#x27;"><meta data-rh="true" property="og:title" content="Kafka timers | Working Group Two"><meta data-rh="true" name="description" content="A timer is a cornerstone of any software that communicates over the network. There are plenty of implementations"><meta data-rh="true" property="og:description" content="A timer is a cornerstone of any software that communicates over the network. There are plenty of implementations"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-02-28T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://www.linkedin.com/in/sergey-zyrianov-8a7ab34/"><meta data-rh="true" property="article:tag" content="kafka,timer,stateless"><link data-rh="true" rel="icon" href="/jp/img/favicons/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.wgtwo.com//jp/blog/kafka-timers/"><link data-rh="true" rel="alternate" href="https://www.wgtwo.com//blog/kafka-timers/" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.wgtwo.com//jp/blog/kafka-timers/" hreflang="jp"><link data-rh="true" rel="alternate" href="https://www.wgtwo.com//blog/kafka-timers/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/jp/blog/rss.xml" title="Working Group Two RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/jp/blog/atom.xml" title="Working Group Two Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-114662288-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><link rel="stylesheet" href="/jp/assets/css/styles.cc2a8a75.css">
<link rel="preload" href="/jp/assets/js/runtime~main.b7adcb89.js" as="script">
<link rel="preload" href="/jp/assets/js/main.73bec23b.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/jp/"><div class="navbar__logo"><img src="/jp/img/logo.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--light_HNdA" height="32px" width="191px"><img src="/jp/img/logo_white.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--dark_i4oU" height="32px" width="191px"></div></a><a class="navbar__item navbar__link" target="_self" href="/jp/technology/">Technology</a><a class="navbar__item navbar__link" target="_self" href="/jp/product-ecosystem/">Product Ecosystem</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/jp/careers/">Join the Team üéâ</a><a class="navbar__item navbar__link" href="/jp/blog/">Blog</a><a class="navbar__item navbar__link sign-up" href="/jp/contact/">Talk to us</a><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/atos-teams-with-wgtwo/">Atos and Working Group Two to deliver core-as-a-service to mobile operators worldwide</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/telco-tech-talk-telenor-aws/">Telco Tech Talk: Three CEOs on the future of the telecom industry, moving to the cloud and transforming company cultures</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/evolution-of-mobile-core/">Q&amp;A with Stephane: The evolution of the mobile core</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/releasing-sip-breakout-api/">Hello abundance, bye-bye complexity: With this new public API you can plug multiple switchboards into the call path - without knowing what a call path is</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/what-we-build-right-now-june22/">What we&#x27;re building on the platform right now: 5GSA, 5GNSA, OCS, content filtering, VoNR, VoLTE on sXGP, VoLTE roaming, support for PBX from Telavox... and more </a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/no-need-for-a-business-case/">The business case for not needing a business case</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/nortel-ecosystem/">Building a product ecosystem: Here&#x27;s a question mobile operators need to hear more often.</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/vxt-joins-marketplace/">Vxt is on a mission to eradicate boring tasks. Now they‚Äôre joining Working Group Two‚Äôs product marketplace.</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/voxist-to-join-marketplace/">Voxist to join the Working Group Two marketplace</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/releasing-our-first-grpc-apis/">We are releasing our first production-ready gRPC APIs!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/new-website/">How I leveraged the 80/20 principle to rebuild wgtwo.com</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/manual-on-me-matt-long/">Manual on Me: Matt Long</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/please-dont-leave-a-message-after-the-beep/">Don&#x27;t leave a message after the beep</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/the-specs-behind-the-specs-part-1/">The specs behind the specs part 1</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/log4j-security-vulnerability/">Zero-day vulnerabilities - Log4j</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/ckh-iod-wg2-public-cloud/">CKH IOD selects Working Group Two for public cloud core network</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/mitsui-knowledge-industry-mki-private-networks-business/">Mitsui Knowledge Industry (MKI) to develop private networks business</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/jp/blog/kafka-timers/">Kafka timers</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/mqtt-event-bridge/">Changing the color of your bulbs: The fancy way</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/forbidden-lore-hacking-dns-routing-for-k8s/">Forbidden lore: hacking DNS routing for k8s</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/were-all-grownups-here/">We&#x27;re all grownups here</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/hackdays-october-2020/">October Virtual Hackdays</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/what-is-a-short-message/">What the heck is a short message?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/a-new-hope-for-products-in-telecom/">A new hope for products in telecom</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/building-software-for-a-telecom-core-network/">Building software for a telecom core network</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/choosing-erlang-formatter/">Choosing an Erlang formatter</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/vowifi-imsi-leak/">VoWifi leaking IMSI</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/extending-k8s/">Extending Kubernetes for our needs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/metrics-unlimited-thanos/">Towards observability nirvana: infinite metric retention with Thanos</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/replacing-jenkins-with-concourse/">We killed the butler: Replacing Jenkins with Concourse</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/hacking-dark-themes-with-css-blend-modes/">Hacking dark themes with CSS blend modes</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Kafka timers</h1><div class="container_mt6G margin-vert--md"><time datetime="2021-02-28T00:00:00.000Z" itemprop="datePublished">February 28, 2021</time> ¬∑ <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/sergey-zyrianov-8a7ab34/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/author-photos/sz.jpg" alt="Sergey Zyrianov"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/sergey-zyrianov-8a7ab34/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Sergey Zyrianov</span></a></div><small class="avatar__subtitle" itemprop="description">Tech Lead for Session Management &amp; Protocol Termination</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>A timer is a cornerstone of any software that communicates over the network. There are plenty of implementations
that provide a timer facility. Most of them are in memory and will lose scheduled timers should the application crash.
In this blog we discuss durable Kafka timers that do not depend on in memory state. By design
we shall assume 1 second resolution of these timers.</p><p>Before taking on timers let&#x27;s cover some Kafka basics.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-concepts">Kafka concepts<a class="hash-link" href="#kafka-concepts" title="Direct link to heading">‚Äã</a></h2><p>There are a few Kafka concepts in play to simulate timers - Kafka topic, Kafka stream, Kafka streams library.
Where <em>topic</em> is append only log of events, <em>stream</em> is a cache of N most recent events on the <em>topic</em>,
and the <em>streams library</em> is a software library implementing the concept of the <em>stream</em>.</p><p>A kafka topic resides inside the Kafka servers, but Kafka streams library keeps track of a topic&#x27;s most recent
events on the application side - the stream. The stream is a key/value cache with random read access unlike
append only topic log. Key/value cache is not the only thing the library provides. It can also join
the streams. When an event and its key appear on a stream, the library looks up the same key in the other streams participating in the join.
It is using key/value cache associated with each stream and gives the result to the application.
The result will have the present event enriched with the matched past events from the joined streams.
Joining two streams will yield the timer callback. Let&#x27;s see how.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation">Implementation<a class="hash-link" href="#implementation" title="Direct link to heading">‚Äã</a></h2><p>Since it is Kafka, timer expiration shall result in an event posted on a topic of user&#x27;s choice at the right time.
This event is delayed until due time by joining two streams: <em>oscillator</em> and <em>timer-request</em>. Callback
event is pushed to <em>timer-request</em> topic with key equal to the expiration timestamp. Oscillator topic
is the clock dial counting seconds since UNIX epoch in real time. At some point it will get to the second
which is equal to the key on <em>timer-request</em> topic, and the join will come up with the callback event.</p><p>An excellent summary on &quot;timer wheel&quot; and other timer algorithms can be found in this linux kernel <a href="https://lwn.net/Articles/156329/" target="_blank" rel="noopener noreferrer">thread</a>.
Our implementation of timers using Kafka resembles the &quot;timer wheel&quot; algorithm with a bucket on each second to keep callbacks.
<em>Oscillator</em> topic models rotating clock dial, <em>timer-request</em> is bucketing callbacks by the expiration timestamp, and join of these two
contains content of the expired bucket with all the callbacks in it.</p><p><img loading="lazy" src="/jp/assets/images/kt-d3c8c75ee99a5f0c4b9fc155ad9418ea.png" width="1024" height="492" class="img_ev3q"></p><p>There are two Kafka applications running together to service these topics:</p><ul><li>Oscillator</li><li>Futures</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="oscillator">Oscillator<a class="hash-link" href="#oscillator" title="Direct link to heading">‚Äã</a></h3><p>With the resolution of 1 second oscillator keeps pushing <em>oscillator</em> topic:</p><div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">while (running) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    val nowSeconds = System.currentTimeMillis() / 1000L</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    while (timestampSeconds &lt; nowSeconds) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        timestampSeconds++</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        KafkaProducers.send(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;oscillator&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            timestampSeconds.toString(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Thread.sleep(200)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="futures">Futures<a class="hash-link" href="#futures" title="Direct link to heading">‚Äã</a></h3><p>When requesting a timer by pushing <em>timer-request</em> topic, the user provides a callback structure
used to dispatch timer event:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">message Future {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    string callBackTopic = 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    string callBackKey = 2;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    bytes callBack = 3;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Joining two streams on the key equal to the UNIX second will give all expired timers, and
their callback coordinates.</p><p>First, setup a join with <em>WINDOW_SIZE</em> large enough to cover the longest timer duration</p><div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">val oscillator = builder.stream&lt;String, String&gt;(&quot;oscillator&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">val timerRequest = builder.stream(&quot;timer-request&quot;, Consumed.with(Serdes.String(), FutureSerde()))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">val timeoutEvents =</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    oscillator.join(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            timerRequest,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            { _: String?, future: Future -&gt; future },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            JoinWindows.of(WINDOW_SIZE),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            StreamJoined.with(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    Serdes.String(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    Serdes.String(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    FutureSerde()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            ).withThisStoreSupplier(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    Stores.persistentWindowStore(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;join-this-store&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                            WINDOW_SIZE.plusMinutes(30),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                            WINDOW_SIZE,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                            true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            ).withOtherStoreSupplier(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    Stores.persistentWindowStore(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;join-other-store&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                            WINDOW_SIZE.plusMinutes(30),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                            WINDOW_SIZE,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                            true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Second, kick of the processing loop looking for expired timers</p><div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">timeoutEvents.process(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        ProcessorSupplier {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            object : Processor&lt;String, Future&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                override fun init(context: ProcessorContext) {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                override fun process(key: String, value: Future) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    KafkaProducers.send(Topic.valueOf(value.callBackTopic),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                            value.callBackKey,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                            value.callBack.toByteArray()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    Metrics.timerFired(value.callBackTopic)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                override fun close() {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cancelling-a-timer">Cancelling a timer<a class="hash-link" href="#cancelling-a-timer" title="Direct link to heading">‚Äã</a></h3><p>There is no way to cancel these timers as events can&#x27;t be easily removed from the Kafka stream.
Still, it is possible to ignore timer events by using a token in callback request, and a variable
in timer receiver state. When scheduling a timer the receiver puts the same token in two places:</p><ul><li>callback struct it publishes on the <em>timer-request</em> topic</li><li>internal variable timerToken</li></ul><p>As timer fires receiver compares value in timerToken and in the callback event. Based on the result it
draws a conclusion if timer is to be ignored or not. All it has to do to cancel a timer is to reset
value in its timerToken variable.</p><p>Since normally Kafka does &quot;at least once&quot; delivery it is a good idea to reset the timerToken immediately
after notification event.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-to-worry-about">What to worry about<a class="hash-link" href="#what-to-worry-about" title="Direct link to heading">‚Äã</a></h3><p>Kafka streams library is using local disk storage to keep the cache. The storage shall be large enough to host
all timer requests based on the product of <em>timer-request</em> topic retention, callback size and timer scheduling rate.
Thankfully Kafka is well-equipped to deal with this sort of troubles.</p><p>Oscillator must keep ticking otherwise timers will stop coming. Make sure to have
metrics/alarms in place to stay on top of Oscillator health. Deploy few of them for redundancy having in
mind the extra load they will generate on timer users.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">‚Äã</a></h2><p>There are many options to export application state to the data tier layer. Timers are often part of that
state. Above we showed how to apply Kafka primitives to achieve a goal of making application &quot;stateless&quot; even
if the state is using timers. It has its costs and benefits.</p><p>Check out openings on the <a href="/jp/careers/">Careers page</a> if you‚Äôre interested in building the future Telco backbone.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/jp/blog/tags/kafka/">kafka</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/jp/blog/tags/timer/">timer</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/jp/blog/tags/stateless/">stateless</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/working-group-two/wgtwo.com/edit/main/blog/../blog/2021-02-28-kafka-timers.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/jp/blog/mitsui-knowledge-industry-mki-private-networks-business/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Mitsui Knowledge Industry (MKI) to develop private networks business</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/jp/blog/mqtt-event-bridge/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Changing the color of your bulbs: The fancy way</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#kafka-concepts" class="table-of-contents__link toc-highlight">Kafka concepts</a></li><li><a href="#implementation" class="table-of-contents__link toc-highlight">Implementation</a><ul><li><a href="#oscillator" class="table-of-contents__link toc-highlight">Oscillator</a></li><li><a href="#futures" class="table-of-contents__link toc-highlight">Futures</a></li><li><a href="#cancelling-a-timer" class="table-of-contents__link toc-highlight">Cancelling a timer</a></li><li><a href="#what-to-worry-about" class="table-of-contents__link toc-highlight">What to worry about</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docs.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">API Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://console.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Console Login<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://support.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Customer Support<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Company</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/docs/about/introduction/">About</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/docs/case-studies/mvnx/">Case Studies</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/team/">Team</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/careers/">Careers</a></li><li class="footer__item"><a href="https://www.wgtwo.com/jp" target="_blank" rel="noopener noreferrer" class="footer__link-item">gk.wgtwo.com ÂêàÂêå‰ºöÁ§æ<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Security</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/security/">Security Overview</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/docs/technology/security-whitepaper/">Security Whitepaper</a></li><li class="footer__item"><a href="https://trust.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trust Report<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/privacy/">Privacy Notice</a></li></ul></div><div class="col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/docs/about/media-and-analysts/">Media &amp; Analysts</a></li><li class="footer__item"><a href="https://twitter.com/workinggrouptwo" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/working-group-two" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://linkedin.com/company/wgtwo" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/contact/">Contact Us</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_BH7S" href="/jp/"><img src="/jp/img/logo_white.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="191px" height="32px"><img src="/jp/img/logo_white.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="191px" height="32px"></a></div><div class="footer__copyright">¬© 2022 Working Group Two AS</div></div></div></footer></div>
<script src="/jp/assets/js/runtime~main.b7adcb89.js"></script>
<script src="/jp/assets/js/main.73bec23b.js"></script>
</body>
</html>