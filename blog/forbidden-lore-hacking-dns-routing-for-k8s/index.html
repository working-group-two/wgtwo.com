<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Forbidden lore: hacking DNS routing for k8s | Career and jobs page updates (#416)</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.wgtwo.com/img/wgtwo-logo.png"><meta data-rh="true" name="twitter:image" content="https://www.wgtwo.com/img/wgtwo-logo.png"><meta data-rh="true" property="og:url" content="https://www.wgtwo.com/blog/forbidden-lore-hacking-dns-routing-for-k8s/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="og:description" content="We help mobile operators innovate at scale, reduce cost and dive into new revenue streams - by building a mobile core network from the ground up and delivering it as-a-service."><meta data-rh="true" name="og:image" content="/img/wgtwo-logo.png"><meta data-rh="true" name="keywords" content="mvne, private network, epc, 5G core, mvno, IMS core, mobile core, evolved packet core epc, mvno core, core as a service&#x27;"><meta data-rh="true" property="og:title" content="Forbidden lore: hacking DNS routing for k8s | Career and jobs page updates (#416)"><meta data-rh="true" name="description" content="At WG2 we’re coming close to having everything running in Kubernetes, which means that almost everything we deploy needs to be pulled from a registry. We have run our own local registry for some time now, to host both locally-built images and cached images from Docker Hub."><meta data-rh="true" property="og:description" content="At WG2 we’re coming close to having everything running in Kubernetes, which means that almost everything we deploy needs to be pulled from a registry. We have run our own local registry for some time now, to host both locally-built images and cached images from Docker Hub."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-12-11T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://www.linkedin.com/in/annaken,https://www.linkedin.com/in/hihrig/,https://www.linkedin.com/in/mattlong/,https://www.linkedin.com/in/yangrunenberger/"><meta data-rh="true" property="article:tag" content="dns,nginx,kubernetes,infrastructure"><link data-rh="true" rel="icon" href="/img/favicons/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.wgtwo.com/blog/forbidden-lore-hacking-dns-routing-for-k8s/"><link data-rh="true" rel="alternate" href="https://www.wgtwo.com/blog/forbidden-lore-hacking-dns-routing-for-k8s/" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.wgtwo.com/jp/blog/forbidden-lore-hacking-dns-routing-for-k8s/" hreflang="jp"><link data-rh="true" rel="alternate" href="https://www.wgtwo.com/blog/forbidden-lore-hacking-dns-routing-for-k8s/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Career and jobs page updates (#416) RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Career and jobs page updates (#416) Atom Feed">



<!-- Google Tag Manager -->
    <script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-N4969FH",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script>
    <!-- End Google Tag Manager --><link rel="stylesheet" href="/assets/css/styles.559cfa0f.css">
<link rel="preload" href="/assets/js/runtime~main.8818999b.js" as="script">
<link rel="preload" href="/assets/js/main.dd1fd2c8.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#000000;color:#b8b8b8" role="banner"><div class="content_knG7 announcementBarContent_xLdY"><a class="announcementBarLinkContainer" target="_blank" href="https://blogs.cisco.com/news/cisco-announces-intent-to-acquire-working-group-two"><img src="/img/cisco.png"><b>Working Group Two is now part of Cisco</b><span class="separator"> | </span><span>Learn more →</span></a></div></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--light_HNdA" height="32px" width="191px"><img src="/img/logo_white.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--dark_i4oU" height="32px" width="191px"></div></a><a class="navbar__item navbar__link" target="_self" href="/technology/">Technology</a><a class="navbar__item navbar__link" target="_self" href="/product-ecosystem/">Product Ecosystem</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Showcase</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/showcase/mobi/">Mobi (MVNO/MNO)</a></li><li><a class="dropdown__link" href="/showcase/ckh-iod/">CKH IOD (MVNE)</a></li><li><a class="dropdown__link" href="/showcase/telenorconnexion/">Telenor Connexion (IoT)</a></li><li><a class="dropdown__link" href="/showcase/mki/">MKI (Private Networks)</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blog/">Blog</a><a class="navbar__item navbar__link sign-up" href="/contact/">Talk to us</a><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link localeDropdown"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/blog/forbidden-lore-hacking-dns-routing-for-k8s/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/jp/blog/forbidden-lore-hacking-dns-routing-for-k8s/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="jp">日本語</a></li></ul></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 blogBackground_WB8r"><div class="container margin-vert--lg"><div class="row"><main class="col col8_DrcQ colOffset2_jfKI singleBlogPageView_LeVK" itemscope="" itemtype="http://schema.org/Blog"><div style="position:fixed;height:4px;background-color:#edf6fa;z-index:999;width:100%;top:0;left:0"><div style="background-color:#93ddff;transition:all 0.5s ease-out;width:0%;height:100%"></div></div><article class="articleContainer_Rf03" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header class="articleCardHeader_doJu"><h1 class="title_xvU1" itemprop="headline">Forbidden lore: hacking DNS routing for k8s</h1><div class="container_iJTo margin-vert--md"><div class="dateContainer_S5xq"><time datetime="2020-12-11T00:00:00.000Z" itemprop="datePublished">December 11, 2020</time> · <!-- -->8 min read</div><div class="iconsContainer_WcqX"><button class="button_jnFd"><svg height="500" width="500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500" class="icon_K6Vf"><path d="M50 0C22.3 0 0 22.3 0 50v400c0 27.7 22.3 50 50 50h400c27.7 0 50-22.3 50-50V50c0-27.7-22.3-50-50-50H50zm89.906 105.781c19.182 0 34.719 15.537 34.719 34.719 0 19.182-15.537 34.75-34.719 34.75-19.182 0-34.719-15.568-34.719-34.75 0-19.182 15.537-34.719 34.72-34.719zm181.875 90.438c3.922.014 7.925.199 13.313.531 26.184 1.615 55.36 22.08 56.219 70.031.706 39.493.5 102.081.5 125.125H332.28c0-23.574.25-72.274.25-106.719 0-15.672-7.035-36.75-32.094-36.75-27.597 0-34.312 25.645-34.312 36.75 0 33.074-.281 85.752-.281 106.72h-59.188c0-35.345.375-156.654.375-190.907 30.568 0 45.191-.063 56.375-.063 0 11.218-.094 18.722-.094 26.907 9.337-18.852 34.832-30.655 45.75-31.219 4.98-.257 8.797-.42 12.72-.406zm-211.594 5.531h59.344v190.063h-59.344V201.75z" style="fill-opacity:1;fill-rule:nonzero"></path></svg></button><button class="button_jnFd"><svg xmlns="http://www.w3.org/2000/svg" height="56.693" width="56.693" viewBox="0 0 56.693 56.693" xml:space="preserve" class="icon_K6Vf"><rect width="100%" height="100%" fill="none"></rect><g class="currentLayer"><title>Layer 1</title><path d="M56.237 11.546a22.859 22.859 0 0 1-6.598 1.809 11.509 11.509 0 0 0 5.051-6.357 22.997 22.997 0 0 1-7.295 2.79 11.473 11.473 0 0 0-8.385-3.629c-6.344 0-11.488 5.144-11.488 11.489 0 .899.101 1.775.298 2.618-9.548-.48-18.014-5.053-23.68-12.004a11.43 11.43 0 0 0-1.555 5.777c0 3.985 2.027 7.502 5.11 9.562a11.456 11.456 0 0 1-5.204-1.438v.145c0 5.565 3.96 10.208 9.215 11.265a11.55 11.55 0 0 1-5.189.195c1.463 4.564 5.705 7.887 10.732 7.979A23.047 23.047 0 0 1 2.98 46.665c-.926 0-1.841-.055-2.74-.161a32.51 32.51 0 0 0 17.61 5.161c21.132 0 32.687-17.505 32.687-32.686 0-.498-.01-.995-.032-1.488a23.268 23.268 0 0 0 5.731-5.945z" class="selected"></path></g></svg></button><button class="button_jnFd"><svg xmlns="http://www.w3.org/2000/svg" width="256" height="256" viewBox="0 0 256 256" class="icon_K6Vf"><rect width="100%" height="100%" fill="none"></rect><g class="currentLayer"><title>Layer 1</title><path fill="none" d="M0 0h256v256H0z"></path><path d="M255.429 115.27a33.99 33.99 0 0 0-56.19-25.705c-17.844-9.453-39.088-15.189-61.287-16.464l5.523-33.14 23.156 3.612a25.705 25.705 0 1 0 2.655-16.783l-31.547-4.886a8.497 8.497 0 0 0-9.666 7.01l-7.329 44.081c-23.155.956-45.46 6.692-64.049 16.57a33.99 33.99 0 0 0-45.249 50.666 65.218 65.218 0 0 0-2.443 17.526c0 23.262 12.746 45.037 36.008 61.076s51.728 23.899 82.956 23.899 60.65-8.498 82.957-23.9 36.007-37.813 36.007-61.075a63.837 63.837 0 0 0-2.443-17.42 34.415 34.415 0 0 0 10.94-25.067zM68.485 145.011a16.995 16.995 0 1 1 16.995 16.995 16.995 16.995 0 0 1-16.995-16.995zm98.464 54.277a85.08 85.08 0 0 1-77.964 0 8.497 8.497 0 0 1 7.754-15.082 68.192 68.192 0 0 0 62.456 0 8.497 8.497 0 0 1 7.754 15.082zm3.505-37.282a16.995 16.995 0 1 1 16.995-16.995 16.995 16.995 0 0 1-16.995 16.995z"></path></g></svg></button><span class="spacer_N6vp">|</span><button class="button_jnFd"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="icon_K6Vf iconLink_fFIC"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path></svg></button></div></div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_q4o9"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/annaken" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/author-photos/ak.jpg" alt="Anna Kennedy"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/annaken" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Anna Kennedy</span></a></div><small class="avatar__subtitle" itemprop="description" title="Tech Lead for Cloud and Edge Infrastructure">Tech Lead for Cloud and Edge Infrastructure</small></div></div></div><div class="col col--6 authorCol_q4o9"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/hihrig/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/author-photos/hi.jpg" alt="Holger Ihrig"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/hihrig/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Holger Ihrig</span></a></div><small class="avatar__subtitle" itemprop="description" title="Software Engineer for Session Management &amp; Protocol Termination">Software Engineer for Session Management &amp; Protocol Termination</small></div></div></div><div class="col col--6 authorCol_q4o9"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/mattlong/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/author-photos/mtl-li.jpg" alt="Matt Long"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/mattlong/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Matt Long</span></a></div><small class="avatar__subtitle" itemprop="description" title="Engineering Manager for Edge, Cloud and Security">Engineering Manager for Edge, Cloud and Security</small></div></div></div><div class="col col--6 authorCol_q4o9"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/yangrunenberger/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/author-photos/yg.jpg" alt="Yan Grunenberger"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/yangrunenberger/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Yan Grunenberger</span></a></div><small class="avatar__subtitle" itemprop="description" title="Software Engineer for Session Management &amp; Protocol Termination">Software Engineer for Session Management &amp; Protocol Termination</small></div></div></div></div></header><div id="__blog-post-container" class="markdown articleContent_wrOu" itemprop="articleBody"><p>At WG2 we’re coming close to having everything running in Kubernetes, which means that almost everything we deploy needs to be pulled from a registry. We have run our own local registry for some time now, to host both locally-built images and cached images from Docker Hub.</p><p>We recently decided to improve the registry solution by implementing <a href="https://goharbor.io/" target="_blank" rel="noopener noreferrer">Harbor</a> to scan images for vulnerabilities on upload, and replicating the registry into each of our multiple environments and regions. This would both eliminate Harbor as a single point of failure, and allow each cluster to pull images locally to minimise data transfer costs through the NAT gateway.</p><p>The overall workflow would look something like:</p><ul><li>images are built and uploaded to Harbor</li><li>Harbor scans for vulnerabilities and pushes images to a private registry</li><li>this registry is replicated to a read-only registry</li><li>the read-only registry is replicated to all environments and regions</li><li>the Kubernetes cluster in each environment deploys from the local read-only registry</li></ul><p><img loading="lazy" alt="Workflow" src="/assets/images/multiregion-13365939553782c33c21219d2e21d410.jpg" width="736" height="331" class="img_ev3q"></p><p>Harbor has to live somewhere, so we decided it should live in the dev environment, close to the CI system that builds the majority of our images. However, container image names contain the registry location that they are pulled from / pushed to, eg <code>reg.wgtwo.com/infra/logstash</code>. Therefore in the dev environment we have to find a way to deal with the fact that we want users and the CI system to push to Harbor, but we also want Kubernetes to pull images from the read-only registry.</p><p>So the main problem becomes: if the image name includes the url <code>reg.wgtwo.com</code>, how to make that point to two different places depending on usage?</p><h1>Solution 1: DNS</h1><p>In non-dev environments, the obvious solution is to redirect <code>reg.wgtwo.com -&gt; read-only-registry</code> in Kubernetes CoreDNS. But in dev, we need different services to go to different places. The DNS model thus needs to look like:</p><p><img loading="lazy" alt="DNS" src="/assets/images/dnsresolution-d0a90858bbeab60834fd5f80b85a9ba5.jpg" width="702" height="483" class="img_ev3q"></p><p>In other words,</p><ul><li><code>Route53</code> sets <code>reg.wgtwo.com -&gt; harbor</code></li><li>K8s coreDNS sets <code>reg.wgtwo.com -&gt; read-only-registry</code></li><li>CI (Concourse) bypasses cluster lookup and goes to <code>Route53</code> instead, such that <code>reg.wgtwo.com -&gt; harbor</code></li></ul><p>We initially deployed a DNS sidecar to the CI system, but with multiple Concourse pods we got multiple sidecars and we really only needed one, plus we had to manipulate Concourse’s internal DNS cache (<code>CONCOURSE_GARDEN_DNS_SERVER</code>) but that broke DNS between Concourse and everything else in the cluster. Replacing the sidecar with a DNS pod in the CI namespace worked better, although then all the CI jobs needed to be updated to use that new pod as their nameserver.</p><p><img loading="lazy" alt="Sleight of hand" src="/assets/images/sleight-of-hand-fbae8de3401322c1485949179d2a6f32.gif" width="455" height="248" class="img_ev3q"></p><p>However at this point we realised that although we want to deploy pods into Kubernetes, the process that does the deploying lives on the Kubernetes nodes, outside of cluster scope.
We don’t do any config management on the nodes, we just let <a href="https://github.com/kubernetes/kops" target="_blank" rel="noopener noreferrer">kOps</a> deploy everything that Kubernetes needs for a cluster, so we were reluctant to introduce an entirely different system just for managing one <code>resolv.conf</code> file. Also the concentric DNS setup would have a very wide scope and be somewhat difficult to debug. Maybe this was a problem better resolved using some clever nginx routing?</p><h1>Solution 2: nginx</h1><p>If we could find some way of differentiating the Harbor traffic from read-only-registry traffic, we could let nginx route requests to the right place.</p><iframe src="https://giphy.com/embed/QaPkV29BJh3gI" width="240" height="177" frameborder="0" class="giphy-embed" allowfullscreen=""></iframe><h1>Solution 2a: nginx routes traffic on IP</h1><ul><li>Traffic from the outside world plus traffic from Concourse needs to go to Harbor.</li><li>Traffic from the Kubernetes cluster needs to go to the read-only-registry.</li></ul><p>The <a href="https://nginx.org/en/docs/http/ngx_http_geo_module.html" target="_blank" rel="noopener noreferrer">nginx geo module</a> sounded like a good idea, where we could set our internal subnet ranges to go to the read-only-registry. However getting the ingress annotations to put this config in the right place turned out to be challenging, since it needs to go outside of both <code>http snippet</code> and <code>server snippet</code> blocks. But before we dug further into this issue we realised that all of the traffic to nginx would arrive via the internet gateway, meaning we wouldn’t see source IP anyway.</p><h1>Solution 2b: nginx routes on custom header</h1><p>The new <code>canary</code> feature in nginx makes this kind of routing very easy - traffic that matches a certain criteria gets sent to a different backend. We could use a custom header such as <code>ro-reg</code> to send internal traffic to the read-only registry.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">annotations:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  nginx.ingress.kubernetes.io/canary: &quot;true&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  nginx.ingress.kubernetes.io/canary-by-header: &quot;ro-reg&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The docker (client) config has an <a href="https://github.com/docker/cli/blob/master/man/docker-config-json.5.md" target="_blank" rel="noopener noreferrer">HttpHeaders</a> section, so it would be easy enough to add this section to all of our image-pull secrets, meaning all internal pulls - but nothing else - should go to the read-only registry.</p><p>We had to rearrange things a little in order to terminate SSL on nginx and not at the registry so that nginx would be able to read the headers, but that was straightforward.</p><p>In our initial tests from the laptop, this worked great. However it quickly transpired that this was the only place it worked from. Where we needed it to work from - the Kubernetes nodes - didn’t run Docker, they run <code>docker-shim</code> on top of <code>containerd</code>, and <code>HttpHeaders</code> <a href="https://github.com/containerd/cri/issues/1400" target="_blank" rel="noopener noreferrer">are not implemented yet</a>. Back to the drawing board.</p><h1>Solution 2c: nginx routes on auth header</h1><p>Getting nervous that we’d used a week to get nothing working, we started clutching at some very hacky straws. Even if docker-shim doesn’t send custom headers, we could see it sending auth headers, and we have different login details for Harbor versus the read-only registry. We wondered if we could route on the auth hash, postponing entirely the discussion about whether we should do such a horrible thing, or the security implications of having the auth hash in a plaintext nginx config.</p><iframe src="https://giphy.com/embed/I8RMi1UY8cEKs" frameborder="20px" class="giphy-embed" allowfullscreen=""></iframe><p>We soon discovered that this solution was also never going to work. In Kubernetes, it is the <code>kubelet</code> process that does the image pull at the start of a pod deployment, and after some wiresharking it turns out that the very first thing kubelet does is make an unauthenticated call to the <code>registry/v2</code> endpoint to fetch metadata which it then uses to begin authentication.</p><p>This is expected behaviour for a docker registry, <a href="https://docs.docker.com/registry/spec/auth/token/" target="_blank" rel="noopener noreferrer">according to documentation</a>, but with nginx routing on auth header, it meant that the initial call was routed to Harbor which sent back an auth URL also for Harbor, and thus kubelet never even arrived at the read-only registry, let alone managed to authenticate.</p><h1>Aside: other issues with headers</h1><p>During this debugging session we also realised that we’d been creating image-pull secrets in Kubernetes with both <code>.dockercfg</code> and <code>.dockerconfigjson</code>, not realising that <code>.dockercfg</code> <a href="https://github.com/moby/moby/pull/12009" target="_blank" rel="noopener noreferrer">is the old format</a> and that <code>.dockercfg</code> likely does not support HttpHeaders at all.</p><p>Kubelet <a href="https://github.com/Kubernetes/Kubernetes/blob/e1fd2d7ff57af153023347d72d17226effd917c8/pkg/credentialprovider/config.go#L44" target="_blank" rel="noopener noreferrer">does support HttpHeaders</a>, but relies on the underlying container runtime to also support them - which is not the case for containerd.</p><p>Additionally, when creating a Kubernetes secret containing <code>.dockerconfigjson</code>, it appears that it is very important that there is no whitespace in the secret, or authentication will fail.</p><h1>Solution 2d: route on some other inherent header</h1><p>As one final attempt at making nginx routing work, we looked for other headers being sent, but there was no single header that let us differentiate between kubelet, laptop, and Concourse.</p><p>Kubelet sends a useragent of either <code>docker</code> or <code>go-http-agent</code> (depending on whether the call is the initial one or a retrial) and filtering on <code>go-http-agent</code> also catches Concourse requests, rendering it useless for this task. We were also worried it might end up catching all sorts of unintended cases since we have quite a lot of <code>go</code>-based applications in our ecosystem.</p><p>We took a moment to mourn the loss of our nginx idea, and went back to a DNS solution.</p><p><img loading="lazy" alt="Mourn" src="/assets/images/pulpfiction-14c68561ce1cdd95a2ad42f3fde27b1e.jpg" width="800" height="450" class="img_ev3q"></p><h1>Solution 3: DNS, again</h1><p>We put the DNS solution back in place again, where</p><ul><li><code>Route53</code> sets <code>reg.wgtwo.com -&gt; harbor</code></li><li>K8s nodes set <code>reg.wgtwo.com -&gt; read-only-registry</code></li><li>K8s coreDNS sets <code>reg.wgtwo.com -&gt; read-only-registry</code></li><li>CI runs an additional coreDNS pod setting <code>reg.wgtwo.com -&gt; harbor</code></li><li>Concourse uses CI coreDNS pod to set <code>reg.wgtwo.com -&gt; harbor</code></li></ul><p>Which brought us back to the problem that was still there: how to update <code>/etc/resolv.conf</code> on the nodes. In the continued absence of config management, we hit upon the wonderful hack of using a privileged pod daemonset to manage the config for us via systemd.</p><p>The privileged pod on each node would write a new config file to <code>/etc/systemd/resolvd.conf</code>, and then restart the systemd service to update the running resolvd process.</p><p>This would thus control configuration on the Kubernetes node from inside of Kubernetes, which is admittedly morally wrong but also works really well. It also keeps the configuration alongside all the rest of our configuration instead of hidden away somewhere new.</p><p><img loading="lazy" alt="wheel change" src="/assets/images/wheelchange-57e19e4d177f74c50d800c3268440f30.gif" width="500" height="282" class="img_ev3q"></p><p>A future solution might be to implement some kind of local DNS server/cache on each node, but for now we’ll settle for a working system and a huge increase in knowledge about the inner workings of many of our components.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/dns/">dns</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/nginx/">nginx</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/kubernetes/">kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/infrastructure/">infrastructure</a></li></ul></div><div class="col sharingSection_o4gn col--3"><button aria-haspopup="true" aria-expanded="false" type="button" class="szh-menu-button sharingButton__GCX"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sharingIcon_aNi7"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg></button></div><div class="col margin-top--sm"><a href="https://github.com/working-group-two/wgtwo.com/edit/main/blog/../blog/2020-12-11-forbidden-lore-hacking-dns-routing-for-k8s.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/mqtt-event-bridge/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Changing the color of your bulbs: The fancy way</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/were-all-grownups-here/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">We&#x27;re all grownups here</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docs.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">API Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://console.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Console Login<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/implementation/">Implementation</a></li><li class="footer__item"><a href="https://support.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Customer Support<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/privacy/">Privacy Notice</a></li></ul></div><div class="col footer__col"><div class="footer__title">Company</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/about/introduction/">About</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/case-studies/mvnx/">Case Studies</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/team/">Team</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/terms-of-use/">Terms of Use</a></li><li class="footer__item"><a href="https://jobs.cisco.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Careers<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.wgtwo.com/jp" target="_blank" rel="noopener noreferrer" class="footer__link-item">wgtwo.com/jp 合同会社<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Security</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/security/">Security Overview</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/technology/security-whitepaper/">Security Whitepaper</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/security/responsible-disclosure/">Responsible Disclosure</a></li><li class="footer__item"><a href="https://trust.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trust Report<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/about/media-and-analysts/">Media &amp; Analysts</a></li><li class="footer__item"><a href="https://www.youtube.com/@workinggrouptwo2286" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/workinggrouptwo" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/working-group-two" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://linkedin.com/company/wgtwo" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/contact/">Contact Us</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_BH7S" href="/"><img src="/img/logo_white.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="191px" height="32px"><img src="/img/logo_white.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="191px" height="32px"></a></div><div class="footer__copyright">© 2023 Working Group Two AS</div></div></div></footer></div>
<script src="/assets/js/runtime~main.8818999b.js"></script>
<script src="/assets/js/main.dd1fd2c8.js"></script>
<!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N4969FH" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) --></body>
</html>